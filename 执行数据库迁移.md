# 数据库迁移执行指南

## 🚀 立即执行步骤

### 第一步：访问 Supabase Dashboard
1. 打开 [Supabase Dashboard](https://supabase.com/dashboard)
2. 使用您的账户登录
3. 选择项目: `wptvwhlazelotraoagwt`

### 第二步：执行增强数据库架构

在 Supabase Dashboard 的 **SQL Editor** 页面中，复制并执行以下 SQL 代码：

```sql
-- 增强数据库架构 - 性能优化和功能扩展

-- 1. 创建视图和物化视图

-- 岗位统计视图
CREATE OR REPLACE VIEW job_statistics AS
SELECT 
    j.id,
    j.title,
    j.company_id,
    c.company_name,
    j.views_count,
    j.applications_count,
    j.created_at,
    COUNT(DISTINCT a.id) as total_applications,
    COUNT(DISTINCT CASE WHEN a.status = 'accepted' THEN a.id END) as accepted_applications,
    AVG(r.rating) as avg_rating
FROM jobs j
LEFT JOIN companies c ON j.company_id = c.id
LEFT JOIN applications a ON j.id = a.job_id
LEFT JOIN reviews r ON j.id = r.job_id
WHERE j.status = 'active'
GROUP BY j.id, c.company_name;

-- 学生统计视图
CREATE OR REPLACE VIEW student_statistics AS
SELECT 
    s.id,
    s.user_id,
    s.real_name,
    s.school,
    s.major,
    COUNT(DISTINCT a.id) as total_applications,
    COUNT(DISTINCT CASE WHEN a.status = 'accepted' THEN a.id END) as accepted_applications,
    AVG(r.rating) as avg_rating
FROM students s
LEFT JOIN applications a ON s.id = a.student_id
LEFT JOIN reviews r ON s.user_id = r.reviewed_id AND r.review_type = 'company_to_student'
GROUP BY s.id;

-- 2. 创建性能优化索引

-- 复合索引优化查询性能
CREATE INDEX IF NOT EXISTS idx_jobs_composite ON jobs(status, category, created_at);
CREATE INDEX IF NOT EXISTS idx_applications_composite ON applications(job_id, status, applied_at);
CREATE INDEX IF NOT EXISTS idx_messages_composite ON messages(sender_id, receiver_id, created_at);

-- 全文搜索索引
CREATE INDEX IF NOT EXISTS idx_jobs_title_search ON jobs USING gin(to_tsvector('simple', title));
CREATE INDEX IF NOT EXISTS idx_jobs_description_search ON jobs USING gin(to_tsvector('simple', description));
CREATE INDEX IF NOT EXISTS idx_companies_search ON companies USING gin(to_tsvector('simple', company_name || ' ' || description));

-- 3. 创建自定义函数

-- 搜索岗位函数
CREATE OR REPLACE FUNCTION search_jobs(
    search_query TEXT DEFAULT NULL,
    categories TEXT[] DEFAULT NULL,
    job_types TEXT[] DEFAULT NULL,
    locations TEXT[] DEFAULT NULL,
    salary_min INTEGER DEFAULT NULL,
    salary_max INTEGER DEFAULT NULL,
    page_num INTEGER DEFAULT 1,
    page_size INTEGER DEFAULT 20
)
RETURNS TABLE(
    id UUID,
    title TEXT,
    company_name TEXT,
    description TEXT,
    salary_range TEXT,
    work_location TEXT,
    job_type TEXT,
    category TEXT,
    created_at TIMESTAMPTZ,
    total_count BIGINT
) AS $$
BEGIN
    RETURN QUERY
    WITH filtered_jobs AS (
        SELECT 
            j.*,
            c.company_name,
            COUNT(*) OVER() as total_count
        FROM jobs j
        JOIN companies c ON j.company_id = c.id
        WHERE j.status = 'active'
        AND (search_query IS NULL OR 
             to_tsvector('simple', j.title || ' ' || j.description) @@ to_tsquery('simple', search_query))
        AND (categories IS NULL OR j.category = ANY(categories))
        AND (job_types IS NULL OR j.job_type = ANY(job_types))
        AND (locations IS NULL OR j.work_location ILIKE ANY(locations))
        AND (salary_min IS NULL OR (j.salary_range ~ '\d+' AND 
             CAST(SUBSTRING(j.salary_range FROM '\d+') AS INTEGER) >= salary_min))
        AND (salary_max IS NULL OR (j.salary_range ~ '\d+' AND 
             CAST(SUBSTRING(j.salary_range FROM '\d+') AS INTEGER) <= salary_max))
        ORDER BY j.created_at DESC
        LIMIT page_size
        OFFSET (page_num - 1) * page_size
    )
    SELECT 
        fj.id,
        fj.title,
        fj.company_name,
        fj.description,
        fj.salary_range,
        fj.work_location,
        fj.job_type,
        fj.category,
        fj.created_at,
        fj.total_count
    FROM filtered_jobs fj;
END;
$$ LANGUAGE plpgsql;

-- 增加浏览量函数
CREATE OR REPLACE FUNCTION increment_job_views(job_id UUID)
RETURNS VOID AS $$
BEGIN
    UPDATE jobs 
    SET views_count = views_count + 1 
    WHERE id = job_id;
END;
$$ LANGUAGE plpgsql;

-- 增加申请数函数
CREATE OR REPLACE FUNCTION increment_job_applications(job_id UUID)
RETURNS VOID AS $$
BEGIN
    UPDATE jobs 
    SET applications_count = applications_count + 1 
    WHERE id = job_id;
END;
$$ LANGUAGE plpgsql;

-- 4. 创建触发器

-- 自动更新申请状态为过期
CREATE OR REPLACE FUNCTION update_expired_applications()
RETURNS TRIGGER AS $$
BEGIN
    UPDATE applications 
    SET status = 'expired' 
    WHERE job_id IN (
        SELECT id FROM jobs 
        WHERE application_deadline < NOW() AND status = 'active'
    );
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER trigger_update_expired_applications
    AFTER INSERT OR UPDATE ON jobs
    FOR EACH STATEMENT
    EXECUTE FUNCTION update_expired_applications();

-- 5. 创建数据验证约束

-- 邮箱格式验证
CREATE OR REPLACE FUNCTION validate_email(email TEXT)
RETURNS BOOLEAN AS $$
BEGIN
    RETURN email ~ '^[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\.[A-Za-z]{2,}$';
END;
$$ LANGUAGE plpgsql;

-- 手机号格式验证
CREATE OR REPLACE FUNCTION validate_phone(phone TEXT)
RETURNS BOOLEAN AS $$
BEGIN
    RETURN phone ~ '^1[3-9]\d{9}$';
END;
$$ LANGUAGE plpgsql;

-- 6. 创建审计表

CREATE TABLE IF NOT EXISTS audit_logs (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID REFERENCES auth.users(id),
    action_type VARCHAR(50) NOT NULL,
    table_name VARCHAR(50) NOT NULL,
    record_id UUID,
    old_values JSONB,
    new_values JSONB,
    ip_address INET,
    user_agent TEXT,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- 审计日志索引
CREATE INDEX IF NOT EXISTS idx_audit_logs_user_id ON audit_logs(user_id);
CREATE INDEX IF NOT EXISTS idx_audit_logs_action_type ON audit_logs(action_type);
CREATE INDEX IF NOT EXISTS idx_audit_logs_created_at ON audit_logs(created_at);

-- 7. 创建数据备份视图

-- 重要数据备份视图
CREATE OR REPLACE VIEW data_backup_summary AS
SELECT 
    'jobs' as table_name,
    COUNT(*) as record_count,
    MAX(created_at) as last_updated
FROM jobs
UNION ALL
SELECT 
    'applications' as table_name,
    COUNT(*) as record_count,
    MAX(created_at) as last_updated
FROM applications
UNION ALL
SELECT 
    'users' as table_name,
    COUNT(*) as record_count,
    MAX(created_at) as last_updated
FROM auth.users;

-- 8. 性能监控视图

CREATE OR REPLACE VIEW performance_metrics AS
SELECT 
    'daily_active_jobs' as metric_name,
    COUNT(*) as metric_value
FROM jobs 
WHERE created_at >= CURRENT_DATE - INTERVAL '1 day' AND status = 'active'
UNION ALL
SELECT 
    'weekly_applications' as metric_name,
    COUNT(*) as metric_value
FROM applications 
WHERE applied_at >= CURRENT_DATE - INTERVAL '7 days'
UNION ALL
SELECT 
    'monthly_new_users' as metric_name,
    COUNT(*) as metric_value
FROM auth.users 
WHERE created_at >= CURRENT_DATE - INTERVAL '30 days';
```

### 第三步：验证迁移结果

执行完成后，在 SQL Editor 中运行以下验证查询：

```sql
-- 验证视图创建成功
SELECT * FROM job_statistics LIMIT 5;

-- 验证索引创建成功
SELECT indexname, indexdef FROM pg_indexes 
WHERE tablename IN ('jobs', 'applications', 'messages') 
ORDER BY tablename, indexname;

-- 验证函数创建成功
SELECT proname, prosrc FROM pg_proc 
WHERE proname IN ('search_jobs', 'increment_job_views', 'increment_job_applications');
```

## ✅ 迁移完成后的特性

### 性能优化
- **全文搜索索引**: 支持快速职位搜索
- **复合索引**: 优化复杂查询性能
- **视图和物化视图**: 提升统计查询速度

### 功能增强
- **高级搜索函数**: 支持多条件复杂搜索
- **自动触发器**: 自动处理过期申请
- **数据验证**: 邮箱和手机号格式验证

### 安全监控
- **审计日志**: 记录所有关键操作
- **性能监控**: 实时系统性能指标
- **数据备份**: 重要数据备份视图

## 🔧 集成测试

迁移完成后，在浏览器控制台中测试新功能：

```javascript
// 测试增强搜索功能
import { enhancedApi } from '@/api/enhanced'

// 测试高级搜索
const testSearch = async () => {
  const result = await enhancedApi.jobs.searchJobs({
    query: '前端开发',
    filters: {
      categories: ['技术'],
      job_types: ['兼职'],
      salary_min: 5000
    }
  })
  console.log('搜索测试结果:', result)
}

// 测试安全验证
const testSecurity = async () => {
  const validation = await enhancedApi.security.validateJobData({
    title: '前端开发工程师',
    description: '负责前端开发工作',
    salary_range: '8000-12000'
  })
  console.log('安全验证结果:', validation)
}
```

## 📊 迁移检查清单

- [ ] 执行增强数据库架构 SQL
- [ ] 验证视图创建成功
- [ ] 验证索引创建成功
- [ ] 验证函数创建成功
- [ ] 测试搜索功能
- [ ] 测试安全验证
- [ ] 检查系统性能

## 🆘 故障排除

如果遇到问题：

1. **SQL 执行错误**: 检查表名和字段名是否正确
2. **权限错误**: 确认有足够的数据库权限
3. **连接问题**: 检查 Supabase 项目状态
4. **性能问题**: 验证索引是否生效

完成数据库迁移后，您的兼职平台将具备企业级的性能、安全和功能特性！