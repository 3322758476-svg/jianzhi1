import{ab as C,r as v,s as d,ac as g,ad as f}from"./index-d856f604.js";const S=C("user",()=>{const _=v(null),r=v(!1),t=v(!1),e=async()=>{var c;t.value=!0;try{const{data:{session:n}}=await d.auth.getSession();if(n!=null&&n.user){const u=n.user.user_metadata,l=(u==null?void 0:u.role)||"student";let p={};if(l==="company"){const{data:o}=await d.from("companies").select("*").eq("user_id",n.user.id).single();o&&(p={companyId:o.id,companyName:o.company_name,industry:o.industry,logoUrl:o.logo_url})}else if(l==="student"){const{data:o}=await d.from("students").select("*").eq("user_id",n.user.id).single();o&&(p={studentId:o.id,realName:o.real_name,school:o.school,major:o.major})}_.value={id:n.user.id,email:n.user.email||"",username:(u==null?void 0:u.username)||((c=n.user.email)==null?void 0:c.split("@")[0])||"",avatar:u==null?void 0:u.avatar_url,role:l,created_at:n.user.created_at,...p},r.value=!0}}catch(n){console.error("初始化用户状态失败:",n)}finally{t.value=!1}},i=async(c,n)=>{var u;t.value=!0;try{const{data:l,error:p}=await d.auth.signInWithPassword({email:c,password:n});if(p)throw p;if(l.user){const o=l.user.user_metadata,w=(o==null?void 0:o.role)||"student";let y={};if(w==="company"){const{data:m}=await d.from("companies").select("*").eq("user_id",l.user.id).single();m&&(y={companyId:m.id,companyName:m.company_name,industry:m.industry,logoUrl:m.logo_url})}else if(w==="student"){const{data:m}=await d.from("students").select("*").eq("user_id",l.user.id).single();m&&(y={studentId:m.id,realName:m.real_name,school:m.school,major:m.major})}_.value={id:l.user.id,email:l.user.email||"",username:(o==null?void 0:o.username)||((u=l.user.email)==null?void 0:u.split("@")[0])||"",avatar:o==null?void 0:o.avatar_url,role:w,created_at:l.user.created_at,...y},r.value=!0}return{success:!0}}catch(l){return{success:!1,error:l.message}}finally{t.value=!1}},a=async(c,n,u,l)=>{t.value=!0;try{const{data:p,error:o}=await d.auth.signUp({email:c,password:n,options:{data:{username:u,role:l}}});if(o)throw o;return{success:!0,user:p.user}}catch(p){return{success:!1,error:p.message}}finally{t.value=!1}},s=async()=>{try{const{error:c}=await d.auth.signOut();if(c)throw c;return _.value=null,r.value=!1,{success:!0}}catch(c){return{success:!1,error:c.message}}};return d.auth.onAuthStateChange((c,n)=>{var u;if(c==="SIGNED_IN"&&(n!=null&&n.user)){const l=n.user.user_metadata;_.value={id:n.user.id,email:n.user.email||"",username:(l==null?void 0:l.username)||((u=n.user.email)==null?void 0:u.split("@")[0])||"",avatar:l==null?void 0:l.avatar_url,role:(l==null?void 0:l.role)||"student",created_at:n.user.created_at},r.value=!0}else c==="SIGNED_OUT"&&(_.value=null,r.value=!1)}),{user:_,isAuthenticated:r,loading:t,initialize:e,login:i,register:a,logout:s}});class A{async getCurrentCompanyId(){const t=S().user;if(!t||t.role!=="company")return console.warn("用户未登录或非企业角色"),null;try{const{data:e,error:i}=await d.from("companies").select("id").eq("user_id",t.id).maybeSingle();return i?(console.warn("获取公司ID失败:",i.message),null):(e==null?void 0:e.id)||null}catch(e){return console.error("获取公司ID异常:",e),null}}async getDashboardStats(){const r=await this.getCurrentCompanyId();if(!r)throw new Error("未找到公司信息，请检查用户权限");try{const[t,e]=await Promise.all([d.from("jobs").select("id, status, created_at").eq("company_id",r),d.from("applications").select("id, status, jobs!inner(company_id)").eq("jobs.company_id",r)]),{data:i,error:a}=t,{data:s,error:c}=e;if(a)throw new Error(`岗位数据获取失败: ${a.message}`);if(c)throw new Error(`申请数据获取失败: ${c.message}`);const n=(i==null?void 0:i.length)||0,u=(i==null?void 0:i.filter(o=>o.status==="active").length)||0,l=(s==null?void 0:s.length)||0,p=(s==null?void 0:s.filter(o=>o.status==="pending").length)||0;return{totalJobs:n,activeJobs:u,totalApplications:l,pendingApplications:p,jobsTrend:this.calculateTrend(i),applicationsTrend:this.calculateTrend(s)}}catch(t){throw console.error("获取控制台统计数据失败:",t),t}}async getCompanyJobs(r={}){const t=await this.getCurrentCompanyId();if(!t)throw new Error("未找到公司信息");if(!await g.hasPermission(f.JOB_VIEW))throw new Error("无权限查看岗位列表");try{let e=d.from("jobs").select("*",{count:"exact"}).eq("company_id",t).order("created_at",{ascending:!1});r.status&&(e=e.eq("status",r.status)),r.keyword&&(e=e.or(`title.ilike.%${r.keyword}%,description.ilike.%${r.keyword}%`));const i=r.page||1,a=r.pageSize||10,s=(i-1)*a,c=s+a-1;e=e.range(s,c);const{data:n,error:u,count:l}=await e;if(u)throw u;return{jobs:n||[],total:l||0,page:i,pageSize:a,totalPages:Math.ceil((l||0)/a)}}catch(e){throw console.error("获取企业岗位列表失败:",e),e}}async createJob(r){const t=await this.getCurrentCompanyId();if(!t)throw new Error("未找到公司信息");if(!await g.hasPermission(f.JOB_CREATE))throw new Error("无权限创建岗位");try{const e=new Date().toISOString(),{data:i,error:a}=await d.from("jobs").insert([{...r,company_id:t,status:r.status||"active",created_at:e,updated_at:e}]).select().single();if(a)throw a;return i}catch(e){throw console.error("创建岗位失败 - 详细错误信息:",{message:e.message,details:e.details,hint:e.hint,code:e.code,originalError:e}),e}}async updateJob(r,t){if(!r||r==="undefined")throw new Error("岗位ID无效");const e=await this.getCurrentCompanyId();if(!e)throw new Error("未找到公司信息");if(!await g.hasPermission(f.JOB_EDIT))throw new Error("无权限编辑岗位");try{const{data:i,error:a}=await d.from("jobs").update({...t,updated_at:new Date().toISOString()}).eq("id",r).eq("company_id",e).select().single();if(a)throw console.error("更新岗位失败 - 详细错误:",{message:a.message,details:a.details,hint:a.hint,code:a.code}),a;return i}catch(i){throw console.error("更新岗位失败 - 异常:",i),i}}async deleteJob(r){const t=await this.getCurrentCompanyId();if(!t)throw new Error("未找到公司信息");if(!await g.hasPermission(f.JOB_DELETE))throw new Error("无权限删除岗位");try{const{error:e}=await d.from("jobs").delete().eq("id",r).eq("company_id",t);if(e)throw e;return{success:!0}}catch(e){throw console.error("删除岗位失败:",e),e}}async getCompanyApplications(r={}){const t=await this.getCurrentCompanyId();if(!t)throw new Error("未找到公司信息");if(!await g.hasPermission(f.APPLICATION_VIEW))throw new Error("无权限查看申请");try{const{data:e,error:i}=await d.from("jobs").select("id").eq("company_id",t);if(i)throw i;const a=(e==null?void 0:e.map(h=>h.id))||[];if(a.length===0)return{applications:[],total:0,page:r.page||1,pageSize:r.pageSize||10,totalPages:0};let s=d.from("applications").select("*",{count:"exact"}).order("created_at",{ascending:!1});r.jobId?s=s.eq("job_id",r.jobId):s=s.in("job_id",a),r.status&&(s=s.eq("status",r.status));const c=r.page||1,n=r.pageSize||10,u=(c-1)*n,l=u+n-1;s=s.range(u,l);const{data:p,error:o,count:w}=await s;if(o)throw o;if(!p||p.length===0)return{applications:[],total:w||0,page:c,pageSize:n,totalPages:Math.ceil((w||0)/n)};const y=[...new Set(p.map(h=>h.job_id))],{data:m}=await d.from("jobs").select("*").in("id",y),E=[...new Set(p.map(h=>h.student_id))],{data:I}=await d.from("students").select("id, real_name, avatar_url, school, major, grade").in("id",E);return{applications:p.map(h=>({...h,jobs:(m==null?void 0:m.find(j=>j.id===h.job_id))||null,profiles:(I==null?void 0:I.find(j=>j.id===h.student_id))||null})),total:w||0,page:c,pageSize:n,totalPages:Math.ceil((w||0)/n)}}catch(e){throw console.error("获取企业申请列表失败:",e),e}}async updateApplicationStatus(r,t,e){const i=await this.getCurrentCompanyId();if(!i)throw new Error("未找到公司信息");let a;switch(t){case"reviewing":a=f.APPLICATION_REVIEW;break;case"accepted":a=f.APPLICATION_APPROVE;break;case"rejected":a=f.APPLICATION_REJECT;break;default:throw new Error("无效的申请状态")}if(!await g.hasPermission(a))throw new Error(`无权限${this.getStatusActionText(t)}申请`);try{const{data:s,error:c}=await d.from("applications").select(`
          id,
          jobs (
            company_id
          )
        `).eq("id",r).eq("jobs.company_id",i).maybeSingle();if(c||!s)throw new Error("申请不存在或无权限操作");const{data:n,error:u}=await d.from("applications").update({status:t,review_notes:e,reviewed_at:new Date().toISOString(),updated_at:new Date().toISOString()}).eq("id",r).select().single();if(u)throw u;return n}catch(s){throw console.error("更新申请状态失败:",s),s}}async exportApplicationsToCSV(r={}){const t=await this.getCurrentCompanyId();if(!t)throw new Error("未找到公司信息");if(!await g.hasPermission(f.APPLICATION_EXPORT))throw new Error("无权限导出申请数据");try{const{data:e,error:i}=await d.from("jobs").select("id").eq("company_id",t);if(i)throw i;const a=(e==null?void 0:e.map(o=>o.id))||[];if(a.length===0)return"";let s=d.from("applications").select(`
          *,
          jobs!inner(title, company_id),
          profiles!applications_student_id_fkey(name, university, major, phone, email)
        `);r.jobId?s=s.eq("job_id",r.jobId):s=s.in("job_id",a),r.status&&(s=s.eq("status",r.status));const{data:c,error:n}=await s;if(n)throw n;const u=["申请ID","岗位名称","学生姓名","大学","专业","联系电话","邮箱","申请状态","申请时间","审核时间","审核备注"],l=(c==null?void 0:c.map(o=>{var w,y,m,E,I,b;return[o.id,((w=o.jobs)==null?void 0:w.title)||"",((y=o.profiles)==null?void 0:y.name)||"",((m=o.profiles)==null?void 0:m.university)||"",((E=o.profiles)==null?void 0:E.major)||"",((I=o.profiles)==null?void 0:I.phone)||"",((b=o.profiles)==null?void 0:b.email)||"",o.status,o.created_at,o.reviewed_at||"",o.review_notes||""]}))||[];return[u.join(","),...l.map(o=>o.map(w=>`"${w}"`).join(","))].join(`
`)}catch(e){throw console.error("导出申请数据失败:",e),e}}async getCompanyAnalytics(r="month"){if(!await this.getCurrentCompanyId())throw new Error("未找到公司信息");if(!await g.hasPermission(f.ANALYTICS_VIEW))throw new Error("无权限查看分析数据");try{const e=await this.getDashboardStats();return{...e,period:r,conversionRate:this.calculateConversionRate(e),averageResponseTime:"24h"}}catch(e){throw console.error("获取企业分析数据失败:",e),e}}calculateTrend(r){if(!r||r.length<2)return 0;const t=r.slice(-2);return t.length<2?0:t[1].id>t[0].id?1:-1}calculateConversionRate(r){return!r.totalApplications||r.totalApplications===0?0:(r.totalApplications-r.pendingApplications)/r.totalApplications*100}getStatusActionText(r){return{reviewing:"审核",accepted:"批准",rejected:"拒绝"}[r]||"处理"}async sendInterviewNotification(r){var t;try{const{data:e,error:i}=await d.from("applications").select(`
          *,
          jobs (
            title
          )
        `).eq("id",r).single();if(i||!e)return console.error("获取申请信息失败:",i),{success:!1,error:"申请信息不存在"};const{data:a,error:s}=await d.from("students").select("user_id").eq("id",e.student_id).single();if(s||!a)return console.error("获取学生信息失败:",s),{success:!1,error:"学生信息不存在"};if(!a.user_id)return console.error("学生用户ID不存在:",a),{success:!1,error:"学生用户信息不完整"};const{error:c}=await d.from("notifications").insert({user_id:a.user_id,type:"application",title:"面试通知",description:`恭喜！您的申请"${((t=e.jobs)==null?void 0:t.title)||"未知岗位"}"已通过审核，请等待面试安排。`,related_id:r,important:!0});return c?(console.error("创建通知失败:",c),{success:!1,error:"发送通知失败"}):(console.log("面试通知发送成功，学生ID:",a.user_id),{success:!0})}catch(e){return console.error("发送面试通知异常:",e),{success:!1,error:"发送通知异常"}}}async sendRejectionNotification(r){var t;try{const{data:e,error:i}=await d.from("applications").select(`
          *,
          jobs (
            title
          )
        `).eq("id",r).single();if(i||!e)return console.error("获取申请信息失败:",i),{success:!1,error:"申请信息不存在"};const{data:a,error:s}=await d.from("students").select("user_id").eq("id",e.student_id).single();if(s||!a)return console.error("获取学生信息失败:",s),{success:!1,error:"学生信息不存在"};if(!a.user_id)return console.error("学生用户ID不存在:",a),{success:!1,error:"学生用户信息不完整"};const{error:c}=await d.from("notifications").insert({user_id:a.user_id,type:"application",title:"申请结果通知",description:`很遗憾，您的申请"${((t=e.jobs)==null?void 0:t.title)||"未知岗位"}"未能通过审核。`,related_id:r,important:!1});return c?(console.error("创建通知失败:",c),{success:!1,error:"发送通知失败"}):(console.log("拒绝通知发送成功，学生ID:",a.user_id),{success:!0})}catch(e){return console.error("发送拒绝通知异常:",e),{success:!1,error:"发送通知异常"}}}}const q=new A;export{q as c};
