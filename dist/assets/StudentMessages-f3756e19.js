import{d as Z,u as ee,r as b,C as se,o as te,c as m,a,b as s,w as d,F as P,e as R,t as C,D as ae,s as y,E as h,i as w,k as v,n as M,P as W,I as X,l as z,W as ne,R as oe,X as re,Y as ie,_ as le}from"./index-d856f604.js";const de={class:"student-messages-page"},ce={class:"messages-container"},ue={class:"conversations-sidebar"},_e={class:"sidebar-header"},me={class:"search-container"},ve={class:"conversations-list"},fe={key:0,class:"loading-container"},pe={key:1,class:"empty-state"},ge={key:2,class:"conversations"},ye=["onClick"],he={class:"conversation-avatar"},we={key:0,class:"unread-dot"},Ce={class:"conversation-info"},ke={class:"conversation-header"},be={class:"conversation-name"},Me={class:"conversation-time"},Ve={class:"conversation-preview"},xe={key:0,class:"unread-badge"},qe={class:"chat-container"},$e={key:0,class:"no-conversation-selected"},Se={key:1,class:"chat-window"},De={class:"chat-header"},Ne={class:"chat-user-info"},Ie={class:"user-details"},ze={class:"user-name"},Te={class:"chat-actions"},Ae={class:"messages-area"},Ue={key:0,class:"loading-container"},Le={key:1,class:"empty-state"},Be={key:2,class:"messages-list"},Fe={class:"message-avatar"},Ee={class:"message-content"},Ke={class:"message-text"},Oe={class:"message-time"},Pe={class:"message-input-area"},Re={class:"input-container"},We={class:"input-actions"},Xe={class:"new-conversation-dialog"},Ye={class:"dialog-actions"},je=Z({__name:"StudentMessages",setup(Ge){const u=ee(),$=b([]),p=b(null),S=b([]),T=b(!1),A=b(!1),I=b(""),x=b(""),D=b(!1),k=b({recipient:"",content:""}),L=se(()=>I.value?$.value.filter(o=>o.name.toLowerCase().includes(I.value.toLowerCase())):$.value),B=async()=>{var o;if((o=u.user)!=null&&o.id){T.value=!0;try{const{data:e,error:n}=await y.from("messages").select("*").or(`sender_id.eq.${u.user.id},receiver_id.eq.${u.user.id}`).order("created_at",{ascending:!1});if(n)throw n;const i=new Map;for(const l of e||[]){const r=l.sender_id===u.user.id?l.receiver_id:l.sender_id;if(!i.has(r)){let _=`用户${r.substring(0,8)}`;try{const{data:f}=await y.from("companies").select("company_name").eq("user_id",r).maybeSingle();if(f)_=f.company_name;else{const{data:g}=await y.from("students").select("name").eq("user_id",r).maybeSingle();g&&(_=g.name)}}catch(f){console.warn("获取伙伴信息失败:",f)}const{count:c}=await y.from("messages").select("*",{count:"exact",head:!0}).eq("receiver_id",u.user.id).eq("sender_id",r).eq("read",!1);i.set(r,{id:r,name:_,avatar:"",lastMessage:l.content,lastMessageTime:new Date(l.created_at),unreadCount:c||0,partnerId:r})}}$.value=Array.from(i.values())}catch(e){console.error("加载对话列表失败:",e),h.error("加载对话列表失败")}finally{T.value=!1}}},F=async o=>{var e,n,i,l;if((e=u.user)!=null&&e.id){A.value=!0;try{const{data:r,error:_}=await y.from("messages").select("*").or(`and(sender_id.eq.${u.user.id},receiver_id.eq.${o}),and(sender_id.eq.${o},receiver_id.eq.${u.user.id})`).order("created_at",{ascending:!0});if(_)throw _;S.value=[];for(const c of r||[]){let f=`用户${c.sender_id.substring(0,8)}`;try{const{data:g}=await y.from("auth.users").select("email, user_metadata").eq("id",c.sender_id).maybeSingle();if(g&&(f=((n=g.user_metadata)==null?void 0:n.username)||((i=g.email)==null?void 0:i.split("@")[0])||`用户${c.sender_id.substring(0,8)}`),!g||!((l=g.user_metadata)!=null&&l.username)){const{data:V}=await y.from("companies").select("company_name").eq("user_id",c.sender_id).maybeSingle();if(V!=null&&V.company_name)f=V.company_name;else{const{data:q}=await y.from("students").select("real_name").eq("user_id",c.sender_id).maybeSingle();q!=null&&q.real_name&&(f=q.real_name)}}}catch(g){console.warn("获取发送者信息失败:",g)}S.value.push({id:c.id,sender:c.sender_id===u.user.id?"我":f,avatar:"",content:c.content,time:new Date(c.created_at),isOwn:c.sender_id===u.user.id})}await K(o)}catch(r){console.error("加载对话消息失败:",r),h.error("加载对话消息失败")}finally{A.value=!1}}},E=async()=>{var o;if(!x.value.trim()){h.warning("请输入消息内容");return}if(!p.value||!((o=u.user)!=null&&o.id)){h.error("请先选择对话");return}try{const{data:e,error:n}=await y.from("messages").insert({sender_id:u.user.id,receiver_id:p.value.partnerId,content:x.value.trim(),type:"text"}).select();if(n)throw n;if(e&&e[0]){const i={id:e[0].id,sender:"我",avatar:"",content:x.value.trim(),time:new Date(e[0].created_at),isOwn:!0};S.value.push(i),x.value="";const l=$.value.find(r=>{var _;return r.id===((_=p.value)==null?void 0:_.id)});l&&(l.lastMessage=i.content,l.lastMessageTime=i.time),h.success("消息发送成功")}}catch(e){console.error("发送消息失败:",e),h.error("发送消息失败")}},K=async o=>{var n,i;if(!((n=u.user)!=null&&n.id))return;const e=o||((i=p.value)==null?void 0:i.partnerId);if(e)try{const{error:l}=await y.from("messages").update({read:!0}).eq("receiver_id",u.user.id).eq("sender_id",e).eq("read",!1);if(l)throw l;const r=$.value.find(_=>_.partnerId===e);r&&(r.unreadCount=0),h.success("标记为已读成功")}catch(l){console.error("标记对话为已读失败:",l)}},Y=o=>{p.value=o,F(o.partnerId)},j=()=>{p.value&&F(p.value.partnerId)},G=()=>{D.value=!0},H=async()=>{var o;if(!k.value.recipient||!k.value.content){h.warning("请填写完整信息");return}try{const e="mock-partner-id",{data:n,error:i}=await y.from("messages").insert({sender_id:(o=u.user)==null?void 0:o.id,receiver_id:e,content:k.value.content,type:"text"}).select();if(i)throw i;h.success("消息发送成功"),D.value=!1,k.value={recipient:"",content:""},B()}catch(e){console.error("创建新对话失败:",e),h.error("创建新对话失败")}},J=()=>{h.info("附件功能开发中")},O=o=>{const n=new Date().getTime()-o.getTime();return n<6e4?"刚刚":n<36e5?`${Math.floor(n/6e4)}分钟前`:n<864e5?`${Math.floor(n/36e5)}小时前`:n<6048e5?`${Math.floor(n/864e5)}天前`:o.toLocaleDateString()};return te(()=>{B()}),(o,e)=>{const n=w("el-button"),i=w("el-input"),l=w("el-skeleton"),r=w("el-empty"),_=w("el-avatar"),c=w("el-icon"),f=w("el-option"),g=w("el-select"),V=w("el-form-item"),q=w("el-form"),Q=w("el-dialog");return v(),m("div",de,[e[14]||(e[14]=a("div",{class:"page-header"},[a("h2",null,"我的消息"),a("p",null,"查看和管理您与企业之间的沟通记录")],-1)),a("div",ce,[a("div",ue,[a("div",_e,[e[7]||(e[7]=a("h3",null,"对话列表",-1)),s(n,{type:"primary",size:"small",onClick:G},{default:d(()=>[...e[6]||(e[6]=[M(" 新对话 ",-1)])]),_:1})]),a("div",me,[s(i,{modelValue:I.value,"onUpdate:modelValue":e[0]||(e[0]=t=>I.value=t),placeholder:"搜索对话","prefix-icon":"Search",clearable:"",size:"small"},null,8,["modelValue"])]),a("div",ve,[T.value?(v(),m("div",fe,[s(l,{rows:5,animated:""})])):L.value.length===0?(v(),m("div",pe,[s(r,{description:"暂无对话"})])):(v(),m("div",ge,[(v(!0),m(P,null,R(L.value,t=>{var N;return v(),m("div",{key:t.id,class:W(["conversation-item",{active:((N=p.value)==null?void 0:N.id)===t.id}]),onClick:U=>Y(t)},[a("div",he,[s(_,{size:40,src:t.avatar},{default:d(()=>{var U;return[M(C((U=t.name)==null?void 0:U.charAt(0)),1)]}),_:2},1032,["src"]),t.unreadCount>0?(v(),m("div",we)):X("",!0)]),a("div",Ce,[a("div",ke,[a("span",be,C(t.name),1),a("span",Me,C(O(t.lastMessageTime)),1)]),a("div",Ve,C(t.lastMessage),1)]),t.unreadCount>0?(v(),m("div",xe,C(t.unreadCount),1)):X("",!0)],10,ye)}),128))]))])]),a("div",qe,[p.value?(v(),m("div",Se,[a("div",De,[a("div",Ne,[s(_,{size:40,src:p.value.avatar},{default:d(()=>{var t;return[M(C((t=p.value.name)==null?void 0:t.charAt(0)),1)]}),_:1},8,["src"]),a("div",Ie,[a("div",ze,C(p.value.name),1),e[8]||(e[8]=a("div",{class:"user-status"},"在线",-1))])]),a("div",Te,[s(n,{type:"text",onClick:j},{default:d(()=>[s(c,null,{default:d(()=>[s(z(ne))]),_:1}),e[9]||(e[9]=M(" 刷新 ",-1))]),_:1}),s(n,{type:"text",onClick:K},{default:d(()=>[s(c,null,{default:d(()=>[s(z(oe))]),_:1}),e[10]||(e[10]=M(" 标记已读 ",-1))]),_:1})])]),a("div",Ae,[A.value?(v(),m("div",Ue,[s(l,{rows:5,animated:""})])):S.value.length===0?(v(),m("div",Le,[s(r,{description:"暂无消息"})])):(v(),m("div",Be,[(v(!0),m(P,null,R(S.value,t=>(v(),m("div",{key:t.id,class:W(["message-item",{"own-message":t.isOwn}])},[a("div",Fe,[s(_,{size:32,src:t.avatar},{default:d(()=>{var N;return[M(C((N=t.sender)==null?void 0:N.charAt(0)),1)]}),_:2},1032,["src"])]),a("div",Ee,[a("div",Ke,C(t.content),1),a("div",Oe,C(O(t.time)),1)])],2))),128))]))]),a("div",Pe,[a("div",Re,[s(i,{modelValue:x.value,"onUpdate:modelValue":e[1]||(e[1]=t=>x.value=t),placeholder:"输入消息内容...",type:"textarea",rows:2,resize:"none",onKeyup:ae(E,["enter"])},null,8,["modelValue"]),a("div",We,[s(n,{type:"text",onClick:J},{default:d(()=>[s(c,null,{default:d(()=>[s(z(re))]),_:1})]),_:1}),s(n,{type:"primary",onClick:E},{default:d(()=>[s(c,null,{default:d(()=>[s(z(ie))]),_:1}),e[11]||(e[11]=M(" 发送 ",-1))]),_:1})])])])])):(v(),m("div",$e,[s(r,{description:"请选择一个对话开始聊天"})]))])]),s(Q,{modelValue:D.value,"onUpdate:modelValue":e[5]||(e[5]=t=>D.value=t),title:"开始新对话",width:"500px"},{default:d(()=>[a("div",Xe,[s(q,{model:k.value,"label-width":"80px"},{default:d(()=>[s(V,{label:"收件人"},{default:d(()=>[s(g,{modelValue:k.value.recipient,"onUpdate:modelValue":e[2]||(e[2]=t=>k.value.recipient=t),placeholder:"选择收件人",style:{width:"100%"}},{default:d(()=>[s(f,{label:"企业A",value:"company1"}),s(f,{label:"企业B",value:"company2"}),s(f,{label:"企业C",value:"company3"})]),_:1},8,["modelValue"])]),_:1}),s(V,{label:"消息内容"},{default:d(()=>[s(i,{modelValue:k.value.content,"onUpdate:modelValue":e[3]||(e[3]=t=>k.value.content=t),type:"textarea",rows:4},null,8,["modelValue"])]),_:1})]),_:1},8,["model"]),a("div",Ye,[s(n,{onClick:e[4]||(e[4]=t=>D.value=!1)},{default:d(()=>[...e[12]||(e[12]=[M("取消",-1)])]),_:1}),s(n,{type:"primary",onClick:H},{default:d(()=>[...e[13]||(e[13]=[M("发送",-1)])]),_:1})])])]),_:1},8,["modelValue"])])}}});const Je=le(je,[["__scopeId","data-v-4458d1be"]]);export{Je as default};
