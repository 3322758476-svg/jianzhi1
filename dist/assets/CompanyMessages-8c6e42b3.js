import{d as Z,u as ee,r as k,C as se,o as te,c as _,a,b as s,w as d,F as O,e as P,t as y,D as ae,s as b,E as h,i as g,k as v,n as M,P as R,I as W,l as S,W as ne,R as oe,X as re,Y as ie,_ as le}from"./index-d856f604.js";const de={class:"company-messages"},ce={class:"messages-container"},ue={class:"conversations-sidebar"},_e={class:"sidebar-header"},ve={class:"search-container"},me={class:"conversations-list"},fe={key:0,class:"loading-container"},pe={key:1,class:"empty-state"},he={key:2,class:"conversations"},ge=["onClick"],ye={class:"conversation-avatar"},we={key:0,class:"unread-dot"},Ce={class:"conversation-info"},ke={class:"conversation-header"},be={class:"conversation-name"},Me={class:"conversation-time"},Ve={class:"conversation-preview"},xe={key:0,class:"unread-badge"},qe={class:"chat-container"},$e={key:0,class:"no-conversation-selected"},De={key:1,class:"chat-window"},Ne={class:"chat-header"},Ie={class:"chat-user-info"},Se={class:"user-details"},ze={class:"user-name"},Te={class:"chat-actions"},Ae={class:"messages-area"},Ue={key:0,class:"loading-container"},Le={key:1,class:"empty-state"},Be={key:2,class:"messages-list"},Fe={class:"message-avatar"},Ee={class:"message-content"},Ke={class:"message-text"},Oe={class:"message-time"},Pe={class:"message-input-area"},Re={class:"input-container"},We={class:"input-actions"},Xe={class:"new-conversation-dialog"},Ye={class:"dialog-actions"},je=Z({__name:"CompanyMessages",setup(Ge){const u=ee(),q=k([]),f=k(null),$=k([]),z=k(!1),T=k(!1),I=k(""),x=k(""),D=k(!1),w=k({recipient:"",content:""}),U=se(()=>I.value?q.value.filter(o=>o.name.toLowerCase().includes(I.value.toLowerCase())):q.value),L=async()=>{var o;if((o=u.user)!=null&&o.id){z.value=!0;try{const{data:e,error:n}=await b.from("messages").select("*").or(`sender_id.eq.${u.user.id},receiver_id.eq.${u.user.id}`).order("created_at",{ascending:!1});if(n)throw n;const r=new Map;for(const i of e||[]){const l=i.sender_id===u.user.id?i.receiver_id:i.sender_id;if(!r.has(l)){let m=`用户${l.substring(0,8)}`;try{const{data:p}=await b.from("students").select("name").eq("user_id",l).maybeSingle();p&&(m=p.name)}catch(p){console.warn("获取学生信息失败:",p)}const{count:c}=await b.from("messages").select("*",{count:"exact",head:!0}).eq("receiver_id",u.user.id).eq("sender_id",l).eq("read",!1);r.set(l,{id:l,name:m,avatar:"",lastMessage:i.content,lastMessageTime:new Date(i.created_at),unreadCount:c||0,partnerId:l})}}q.value=Array.from(r.values())}catch(e){console.error("加载对话列表失败:",e),h.error("加载对话列表失败")}finally{z.value=!1}}},B=async o=>{var e,n,r,i;if((e=u.user)!=null&&e.id){T.value=!0;try{const{data:l,error:m}=await b.from("messages").select("*").or(`and(sender_id.eq.${u.user.id},receiver_id.eq.${o}),and(sender_id.eq.${o},receiver_id.eq.${u.user.id})`).order("created_at",{ascending:!0});if(m)throw m;$.value=[];for(const c of l||[]){let p=`用户${c.sender_id.substring(0,8)}`;try{const{data:C}=await b.from("auth.users").select("email, user_metadata").eq("id",c.sender_id).maybeSingle();if(C&&(p=((n=C.user_metadata)==null?void 0:n.username)||((r=C.email)==null?void 0:r.split("@")[0])||`用户${c.sender_id.substring(0,8)}`),!C||!((i=C.user_metadata)!=null&&i.username)){const{data:V}=await b.from("students").select("real_name").eq("user_id",c.sender_id).maybeSingle();V!=null&&V.real_name&&(p=V.real_name)}}catch(C){console.warn("获取发送者信息失败:",C)}$.value.push({id:c.id,sender:c.sender_id===u.user.id?"我":p,avatar:"",content:c.content,time:new Date(c.created_at),isOwn:c.sender_id===u.user.id})}await E(o)}catch(l){console.error("加载对话消息失败:",l),h.error("加载对话消息失败")}finally{T.value=!1}}},F=async()=>{var o;if(!x.value.trim()){h.warning("请输入消息内容");return}if(!f.value||!((o=u.user)!=null&&o.id)){h.error("请先选择对话");return}try{const{data:e,error:n}=await b.from("messages").insert({sender_id:u.user.id,receiver_id:f.value.partnerId,content:x.value.trim(),type:"text"}).select();if(n)throw n;if(e&&e[0]){const r={id:e[0].id,sender:"我",avatar:"",content:x.value.trim(),time:new Date(e[0].created_at),isOwn:!0};$.value.push(r),x.value="";const i=q.value.find(l=>{var m;return l.id===((m=f.value)==null?void 0:m.id)});i&&(i.lastMessage=r.content,i.lastMessageTime=r.time),h.success("消息发送成功")}}catch(e){console.error("发送消息失败:",e),h.error("发送消息失败")}},E=async o=>{var n,r;if(!((n=u.user)!=null&&n.id))return;const e=o||((r=f.value)==null?void 0:r.partnerId);if(e)try{const{error:i}=await b.from("messages").update({read:!0}).eq("receiver_id",u.user.id).eq("sender_id",e).eq("read",!1);if(i)throw i;const l=q.value.find(m=>m.partnerId===e);l&&(l.unreadCount=0),h.success("标记为已读成功")}catch(i){console.error("标记对话为已读失败:",i)}},X=o=>{f.value=o,B(o.partnerId)},Y=()=>{f.value&&B(f.value.partnerId)},j=()=>{D.value=!0},G=async()=>{var o;if(!w.value.recipient||!w.value.content){h.warning("请填写完整信息");return}try{const e="mock-student-id",{data:n,error:r}=await b.from("messages").insert({sender_id:(o=u.user)==null?void 0:o.id,receiver_id:e,content:w.value.content,type:"text"}).select();if(r)throw r;h.success("消息发送成功"),D.value=!1,w.value={recipient:"",content:""},L()}catch(e){console.error("创建新对话失败:",e),h.error("创建新对话失败")}},H=()=>{h.info("附件功能开发中")},K=o=>{const n=new Date().getTime()-o.getTime();return n<6e4?"刚刚":n<36e5?`${Math.floor(n/6e4)}分钟前`:n<864e5?`${Math.floor(n/36e5)}小时前`:n<6048e5?`${Math.floor(n/864e5)}天前`:o.toLocaleDateString()};return te(()=>{L()}),(o,e)=>{const n=g("el-button"),r=g("el-input"),i=g("el-skeleton"),l=g("el-empty"),m=g("el-avatar"),c=g("el-icon"),p=g("el-option"),C=g("el-select"),V=g("el-form-item"),J=g("el-form"),Q=g("el-dialog");return v(),_("div",de,[e[14]||(e[14]=a("div",{class:"page-header"},[a("h1",null,"消息中心"),a("p",null,"管理您的企业消息和通知")],-1)),a("div",ce,[a("div",ue,[a("div",_e,[e[7]||(e[7]=a("h3",null,"对话列表",-1)),s(n,{type:"primary",size:"small",onClick:j},{default:d(()=>[...e[6]||(e[6]=[M(" 新对话 ",-1)])]),_:1})]),a("div",ve,[s(r,{modelValue:I.value,"onUpdate:modelValue":e[0]||(e[0]=t=>I.value=t),placeholder:"搜索对话","prefix-icon":"Search",clearable:"",size:"small"},null,8,["modelValue"])]),a("div",me,[z.value?(v(),_("div",fe,[s(i,{rows:5,animated:""})])):U.value.length===0?(v(),_("div",pe,[s(l,{description:"暂无对话"})])):(v(),_("div",he,[(v(!0),_(O,null,P(U.value,t=>{var N;return v(),_("div",{key:t.id,class:R(["conversation-item",{active:((N=f.value)==null?void 0:N.id)===t.id}]),onClick:A=>X(t)},[a("div",ye,[s(m,{size:40,src:t.avatar},{default:d(()=>{var A;return[M(y((A=t.name)==null?void 0:A.charAt(0)),1)]}),_:2},1032,["src"]),t.unreadCount>0?(v(),_("div",we)):W("",!0)]),a("div",Ce,[a("div",ke,[a("span",be,y(t.name),1),a("span",Me,y(K(t.lastMessageTime)),1)]),a("div",Ve,y(t.lastMessage),1)]),t.unreadCount>0?(v(),_("div",xe,y(t.unreadCount),1)):W("",!0)],10,ge)}),128))]))])]),a("div",qe,[f.value?(v(),_("div",De,[a("div",Ne,[a("div",Ie,[s(m,{size:40,src:f.value.avatar},{default:d(()=>{var t;return[M(y((t=f.value.name)==null?void 0:t.charAt(0)),1)]}),_:1},8,["src"]),a("div",Se,[a("div",ze,y(f.value.name),1),e[8]||(e[8]=a("div",{class:"user-status"},"在线",-1))])]),a("div",Te,[s(n,{type:"text",onClick:Y},{default:d(()=>[s(c,null,{default:d(()=>[s(S(ne))]),_:1}),e[9]||(e[9]=M(" 刷新 ",-1))]),_:1}),s(n,{type:"text",onClick:E},{default:d(()=>[s(c,null,{default:d(()=>[s(S(oe))]),_:1}),e[10]||(e[10]=M(" 标记已读 ",-1))]),_:1})])]),a("div",Ae,[T.value?(v(),_("div",Ue,[s(i,{rows:5,animated:""})])):$.value.length===0?(v(),_("div",Le,[s(l,{description:"暂无消息"})])):(v(),_("div",Be,[(v(!0),_(O,null,P($.value,t=>(v(),_("div",{key:t.id,class:R(["message-item",{"own-message":t.isOwn}])},[a("div",Fe,[s(m,{size:32,src:t.avatar},{default:d(()=>{var N;return[M(y((N=t.sender)==null?void 0:N.charAt(0)),1)]}),_:2},1032,["src"])]),a("div",Ee,[a("div",Ke,y(t.content),1),a("div",Oe,y(K(t.time)),1)])],2))),128))]))]),a("div",Pe,[a("div",Re,[s(r,{modelValue:x.value,"onUpdate:modelValue":e[1]||(e[1]=t=>x.value=t),placeholder:"输入消息内容...",type:"textarea",rows:2,resize:"none",onKeyup:ae(F,["enter"])},null,8,["modelValue"]),a("div",We,[s(n,{type:"text",onClick:H},{default:d(()=>[s(c,null,{default:d(()=>[s(S(re))]),_:1})]),_:1}),s(n,{type:"primary",onClick:F},{default:d(()=>[s(c,null,{default:d(()=>[s(S(ie))]),_:1}),e[11]||(e[11]=M(" 发送 ",-1))]),_:1})])])])])):(v(),_("div",$e,[s(l,{description:"请选择一个对话开始聊天"})]))])]),s(Q,{modelValue:D.value,"onUpdate:modelValue":e[5]||(e[5]=t=>D.value=t),title:"开始新对话",width:"500px"},{default:d(()=>[a("div",Xe,[s(J,{model:w.value,"label-width":"80px"},{default:d(()=>[s(V,{label:"收件人"},{default:d(()=>[s(C,{modelValue:w.value.recipient,"onUpdate:modelValue":e[2]||(e[2]=t=>w.value.recipient=t),placeholder:"选择收件人",style:{width:"100%"}},{default:d(()=>[s(p,{label:"学生A",value:"student1"}),s(p,{label:"学生B",value:"student2"}),s(p,{label:"学生C",value:"student3"})]),_:1},8,["modelValue"])]),_:1}),s(V,{label:"消息内容"},{default:d(()=>[s(r,{modelValue:w.value.content,"onUpdate:modelValue":e[3]||(e[3]=t=>w.value.content=t),type:"textarea",rows:4},null,8,["modelValue"])]),_:1})]),_:1},8,["model"]),a("div",Ye,[s(n,{onClick:e[4]||(e[4]=t=>D.value=!1)},{default:d(()=>[...e[12]||(e[12]=[M("取消",-1)])]),_:1}),s(n,{type:"primary",onClick:G},{default:d(()=>[...e[13]||(e[13]=[M("发送",-1)])]),_:1})])])]),_:1},8,["modelValue"])])}}});const Je=le(je,[["__scopeId","data-v-f19ceb1e"]]);export{Je as default};
