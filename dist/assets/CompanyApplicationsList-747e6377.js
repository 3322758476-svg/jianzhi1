import{c as F}from"./companyDataService-d2da87ef.js";import{d as se,r as x,aa as ee,i as w,k as v,p as $,w as r,c as y,b as d,a as t,t as m,n as h,F as K,e as O,P as ne,I as M,s as C,E as g,V as te,_ as ae,o as ie,j as oe,f as le}from"./index-d856f604.js";const re={key:0,class:"application-detail"},ce={class:"student-basic"},de={class:"avatar-section"},ue={class:"student-name"},pe={class:"student-details"},me={class:"detail-row"},ve={class:"value"},_e={class:"detail-row"},ge={class:"value"},fe={class:"detail-row"},ye={class:"value"},we={class:"detail-row"},he={class:"value"},be={class:"detail-row"},ke={class:"value"},Ce={class:"card-header"},xe={class:"application-details"},De={class:"detail-row"},Se={class:"value"},ze={class:"detail-row"},$e={class:"value"},Te={class:"detail-row"},je={class:"value"},Ae={class:"card-header"},Ne={class:"messages-section"},Ve={key:0,class:"loading-container"},Be={key:1,class:"empty-content"},Ee={key:2,class:"messages-list"},Ie={class:"message-avatar"},Ue={class:"message-content"},Le={class:"message-header"},qe={class:"sender-name"},Fe={class:"message-time"},Me={class:"message-text"},Pe={class:"resume-sections"},Re={class:"resume-section"},Je={key:0},Ge={key:1,class:"empty-content"},He={class:"resume-section"},Ke={key:0},Oe={key:1,class:"empty-content"},Qe={class:"resume-section"},We={key:0},Xe={class:"experience-title"},Ye={class:"experience-company"},Ze={class:"experience-period"},et={class:"experience-description"},tt={key:1,class:"empty-content"},st={class:"action-buttons"},at=se({__name:"ApplicationDetailDialog",props:{visible:{type:Boolean},application:{}},emits:["update:visible","status-change"],setup(p,{emit:P}){const f=p,E=P,T=x(f.visible),D=x([]),A=x(!1);ee(()=>f.visible,l=>{T.value=l}),ee(T,l=>{E("update:visible",l),l&&f.application&&N()});const I=()=>{T.value=!1},N=async()=>{var l,e;if(!((e=(l=f.application)==null?void 0:l.student)!=null&&e.id)){console.error("无法获取学生信息");return}try{A.value=!0;const{data:{user:o}}=await C.auth.getUser();if(!o){g.warning("用户未登录");return}let _=null;try{const{data:u,error:S}=await C.from("students").select("user_id").eq("id",f.application.student.id).maybeSingle();S?console.warn("查询学生数据失败，尝试使用默认值:",S.message):u!=null&&u.user_id&&(_=u.user_id)}catch(u){console.warn("学生数据查询异常:",u)}if(!_){console.warn("无法获取学生用户ID，无法发送消息"),g.error("无法获取学生用户信息，请确保学生已注册账户");return}const a=await B(o.id,_),{data:s,error:n}=await C.from("messages").select("*").eq("conversation_id",a).order("created_at",{ascending:!0});if(n){console.error("获取消息失败:",n),g.error("获取消息失败");return}D.value=(s||[]).map(u=>({id:u.id,content:u.content,created_at:u.created_at,sender_name:u.sender_id===o.id?"我":"对方",avatar:"",sent_by_me:u.sender_id===o.id}))}catch(o){console.error("加载消息异常:",o),g.error("加载消息失败")}finally{A.value=!1}},V=async l=>{try{let e="";switch(l){case"reviewing":e="确定开始审核此申请吗？";break;case"accepted":e="确定通过此申请吗？";break;case"rejected":e="确定拒绝此申请吗？";break}await te.confirm(e,"确认操作",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}),E("status-change",f.application.id,l),g.success("操作成功"),l==="accepted"&&await U()}catch{}},U=async()=>{var l,e,o,_;try{if(!((e=(l=f.application)==null?void 0:l.student)!=null&&e.id)){console.error("无法获取学生信息");return}const{data:{user:a}}=await C.auth.getUser();if(!a){console.error("用户未登录");return}let s=null;try{if((o=f.application.student)!=null&&o.user_id)s=f.application.student.user_id;else{const{data:i,error:k}=await C.from("students").select("user_id").eq("id",f.application.student.id).maybeSingle();k?console.error("查询学生数据失败:",k):i!=null&&i.user_id&&(s=i.user_id)}}catch(i){console.error("获取学生用户ID异常:",i)}if(!s){console.error("无法获取学生用户ID，无法发送通知。学生ID:",(_=f.application.student)==null?void 0:_.id),g.error("无法获取学生用户信息，请确保学生已注册账户");return}console.log("获取到的学生用户ID:",s);let n="企业";try{const{data:i}=await C.from("companies").select("company_name").eq("user_id",a.id).maybeSingle();i!=null&&i.company_name&&(n=i.company_name)}catch(i){console.warn("获取企业信息失败:",i)}const u=`恭喜！您的申请已通过 ${n} 的审核。请查看消息详情。`;try{const{error:i}=await C.from("notifications").insert({user_id:s,type:"application",title:"申请通过通知",description:u,related_id:f.application.id,important:!0});i&&console.warn("发送通知失败（可能是权限问题）:",i)}catch(i){console.warn("通知发送异常:",i)}const S=`恭喜！您的申请已通过审核。${n} 已同意您的申请。请保持联系方式畅通，我们会尽快与您联系安排后续事宜。`,b=await B(a.id,s),{error:z}=await C.from("messages").insert({conversation_id:b,sender_id:a.id,receiver_id:s,content:S,type:"system"});z&&console.error("发送消息失败:",z),g.success("已发送申请通过通知给学生")}catch(a){console.error("发送通知和消息失败:",a),g.error("发送通知失败，但申请状态已更新")}},L=async()=>{var l,e;try{if(!((e=(l=f.application)==null?void 0:l.student)!=null&&e.id)){g.warning("无法获取学生信息");return}const{data:{user:o}}=await C.auth.getUser();if(!o){g.warning("用户未登录");return}let _=null;try{const{data:s,error:n}=await C.from("students").select("user_id").eq("id",f.application.student.id).maybeSingle();n?console.warn("查询学生数据失败，尝试使用默认值:",n.message):s!=null&&s.user_id&&(_=s.user_id)}catch(s){console.warn("学生数据查询异常:",s)}if(!_){console.warn("无法获取学生用户ID，无法发送消息"),g.error("无法获取学生用户信息，请确保学生已注册账户");return}const a=await te.prompt("请输入要发送的消息","发送消息",{confirmButtonText:"发送",cancelButtonText:"取消",inputType:"textarea",inputPlaceholder:"请输入消息内容..."});if(a.value){const{success:s,error:n}=await j(_,a.value);s?(g.success("消息发送成功"),await N()):g.error(`消息发送失败: ${n}`)}}catch(o){o!=="cancel"&&g.error("发送消息失败")}},B=async(l,e)=>{try{try{const{data:o,error:_}=await C.from("conversations").select("id").or(`student_id.eq.${l},company_id.eq.${e},student_id.eq.${e},company_id.eq.${l}`);if(_)return console.warn("对话表查询失败，回退到旧的消息系统:",_.message),"fallback-conversation";if(o&&o.length>0)return o[0].id;const{data:a,error:s}=await C.from("conversations").insert([{student_id:l,company_id:e}]).select("id").single();return s?(console.warn("创建对话失败，回退到旧的消息系统:",s.message),"fallback-conversation"):a.id}catch(o){return console.warn("对话表操作异常，回退到旧的消息系统:",o),"fallback-conversation"}}catch(o){return console.error("确保对话关系失败:",o),"fallback-conversation"}},j=async(l,e)=>{try{const{data:{user:o}}=await C.auth.getUser();if(!o)return{success:!1,error:"用户未登录"};const _=await B(o.id,l),{error:a}=await C.from("messages").insert({conversation_id:_,sender_id:o.id,receiver_id:l,content:e,type:"text"});return a?(console.error("发送消息失败:",a),{success:!1,error:a.message}):{success:!0}}catch(o){return console.error("发送消息异常:",o),{success:!1,error:o.message}}},Q=()=>{g.info("简历下载功能开发中")},q=l=>({pending:"warning",reviewing:"info",accepted:"success",rejected:"danger"})[l]||"info",W=l=>({pending:"待处理",reviewing:"审核中",accepted:"已通过",rejected:"已拒绝"})[l]||"未知",X=l=>new Date(l).toLocaleString("zh-CN"),Y=l=>{const e=new Date(l),o=new Date;if(o.getTime()-e.getTime(),e.toDateString()===o.toDateString())return e.toLocaleTimeString("zh-CN",{hour:"2-digit",minute:"2-digit"});const _=new Date(o);if(_.setDate(_.getDate()-1),e.toDateString()===_.toDateString())return"昨天 "+e.toLocaleTimeString("zh-CN",{hour:"2-digit",minute:"2-digit"});const a=new Date(o);return a.setDate(a.getDate()-7),e>a?["周日","周一","周二","周三","周四","周五","周六"][e.getDay()]+" "+e.toLocaleTimeString("zh-CN",{hour:"2-digit",minute:"2-digit"}):e.toLocaleDateString("zh-CN")+" "+e.toLocaleTimeString("zh-CN",{hour:"2-digit",minute:"2-digit"})};return(l,e)=>{var b,z;const o=w("el-avatar"),_=w("el-card"),a=w("el-tag"),s=w("el-button"),n=w("el-skeleton"),u=w("el-empty"),S=w("el-dialog");return v(),$(S,{modelValue:T.value,"onUpdate:modelValue":e[3]||(e[3]=i=>T.value=i),title:`申请详情 - ${((z=(b=p.application)==null?void 0:b.student)==null?void 0:z.name)||"未知学生"}`,width:"800px","before-close":I},{default:r(()=>[p.application?(v(),y("div",re,[d(_,{class:"student-info-card"},{header:r(()=>[...e[4]||(e[4]=[t("div",{class:"card-header"},[t("span",null,"学生信息")],-1)])]),default:r(()=>[t("div",ce,[t("div",de,[d(o,{size:80,src:p.application.student.avatar},null,8,["src"]),t("div",ue,m(p.application.student.name),1)]),t("div",pe,[t("div",me,[e[5]||(e[5]=t("span",{class:"label"},"学校：",-1)),t("span",ve,m(p.application.student.school||"未填写"),1)]),t("div",_e,[e[6]||(e[6]=t("span",{class:"label"},"专业：",-1)),t("span",ge,m(p.application.student.major||"未填写"),1)]),t("div",fe,[e[7]||(e[7]=t("span",{class:"label"},"年级：",-1)),t("span",ye,m(p.application.student.grade||"未填写"),1)]),t("div",we,[e[8]||(e[8]=t("span",{class:"label"},"联系方式：",-1)),t("span",he,m(p.application.student.phone||"未填写"),1)]),t("div",be,[e[9]||(e[9]=t("span",{class:"label"},"邮箱：",-1)),t("span",ke,m(p.application.student.email||"未填写"),1)])])])]),_:1}),d(_,{class:"application-info-card"},{header:r(()=>[t("div",Ce,[e[10]||(e[10]=t("span",null,"申请信息",-1)),d(a,{type:q(p.application.status)},{default:r(()=>[h(m(W(p.application.status)),1)]),_:1},8,["type"])])]),default:r(()=>[t("div",xe,[t("div",De,[e[11]||(e[11]=t("span",{class:"label"},"申请岗位：",-1)),t("span",Se,m(p.application.job.title),1)]),t("div",ze,[e[12]||(e[12]=t("span",{class:"label"},"申请时间：",-1)),t("span",$e,m(X(p.application.applyTime)),1)]),t("div",Te,[e[13]||(e[13]=t("span",{class:"label"},"申请留言：",-1)),t("span",je,m(p.application.message||"无留言"),1)])])]),_:1}),d(_,{class:"messages-card"},{header:r(()=>[t("div",Ae,[e[15]||(e[15]=t("span",null,"消息历史",-1)),d(s,{type:"primary",size:"small",onClick:N},{default:r(()=>[...e[14]||(e[14]=[h(" 刷新消息 ",-1)])]),_:1})])]),default:r(()=>[t("div",Ne,[A.value?(v(),y("div",Ve,[d(n,{rows:3,animated:""})])):D.value.length===0?(v(),y("div",Be,[d(u,{description:"暂无消息记录","image-size":60})])):(v(),y("div",Ee,[(v(!0),y(K,null,O(D.value,i=>(v(),y("div",{key:i.id,class:ne(["message-item",{"sent-by-me":i.sent_by_me}])},[t("div",Ie,[d(o,{size:32,src:i.avatar},{default:r(()=>{var k;return[h(m((k=i.sender_name)==null?void 0:k.charAt(0)),1)]}),_:2},1032,["src"])]),t("div",Ue,[t("div",Le,[t("span",qe,m(i.sender_name),1),t("span",Fe,m(Y(i.created_at)),1)]),t("div",Me,m(i.content),1)])],2))),128))]))])]),_:1}),d(_,{class:"resume-info-card"},{header:r(()=>[...e[16]||(e[16]=[t("div",{class:"card-header"},[t("span",null,"简历信息")],-1)])]),default:r(()=>[t("div",Pe,[t("div",Re,[e[17]||(e[17]=t("h4",null,"教育背景",-1)),p.application.resume.education?(v(),y("div",Je,[t("p",null,m(p.application.resume.education),1)])):(v(),y("div",Ge,[d(u,{description:"未填写教育背景","image-size":60})]))]),t("div",He,[e[18]||(e[18]=t("h4",null,"技能特长",-1)),p.application.resume.skills&&p.application.resume.skills.length>0?(v(),y("div",Ke,[(v(!0),y(K,null,O(p.application.resume.skills,i=>(v(),$(a,{key:i,type:"info",size:"small",style:{"margin-right":"8px","margin-bottom":"8px"}},{default:r(()=>[h(m(i),1)]),_:2},1024))),128))])):(v(),y("div",Oe,[d(u,{description:"未填写技能特长","image-size":60})]))]),t("div",Qe,[e[19]||(e[19]=t("h4",null,"工作经历",-1)),p.application.resume.experiences&&p.application.resume.experiences.length>0?(v(),y("div",We,[(v(!0),y(K,null,O(p.application.resume.experiences,i=>(v(),y("div",{key:i.id,class:"experience-item"},[t("div",Xe,m(i.title),1),t("div",Ye,m(i.company),1),t("div",Ze,m(i.period),1),t("div",et,m(i.description),1)]))),128))])):(v(),y("div",tt,[d(u,{description:"未填写工作经历","image-size":60})]))])])]),_:1}),t("div",st,[p.application.status==="pending"?(v(),$(s,{key:0,type:"primary",onClick:e[0]||(e[0]=i=>V("reviewing"))},{default:r(()=>[...e[20]||(e[20]=[h(" 开始审核 ",-1)])]),_:1})):M("",!0),p.application.status==="reviewing"?(v(),$(s,{key:1,type:"success",onClick:e[1]||(e[1]=i=>V("accepted"))},{default:r(()=>[...e[21]||(e[21]=[h(" 通过申请 ",-1)])]),_:1})):M("",!0),p.application.status==="reviewing"?(v(),$(s,{key:2,type:"danger",onClick:e[2]||(e[2]=i=>V("rejected"))},{default:r(()=>[...e[22]||(e[22]=[h(" 拒绝申请 ",-1)])]),_:1})):M("",!0),d(s,{onClick:L},{default:r(()=>[...e[23]||(e[23]=[h(" 发送消息 ",-1)])]),_:1}),d(s,{onClick:Q},{default:r(()=>[...e[24]||(e[24]=[h(" 下载简历 ",-1)])]),_:1})])])):M("",!0)]),_:1},8,["modelValue","title"])}}});const nt=ae(at,[["__scopeId","data-v-18084ec3"]]),it={class:"company-applications-list"},ot={class:"filter-content"},lt={class:"filter-group"},rt={class:"filter-actions"},ct={class:"table-header"},dt={class:"total-count"},ut={class:"student-info"},pt={class:"student-details"},mt={class:"name"},vt={class:"meta"},_t={class:"pagination-section"},gt=se({__name:"CompanyApplicationsList",props:{statusFilter:{default:""}},setup(p){const P=p,f=x(""),E=x(P.statusFilter),T=x([]),D=x(1),A=x(10),I=x(!1),N=x(0),V=x([]),U=x([]),L=x(!1),B=x(null);ee(()=>P.statusFilter,a=>{E.value=a,D.value=1,j()});const j=async()=>{try{I.value=!0;const a=await F.getCompanyJobs({page:1,pageSize:100});V.value=a.jobs.map(n=>({id:n.id,title:n.title}));const s=await F.getCompanyApplications({status:E.value||void 0,jobId:f.value||void 0,page:D.value,pageSize:A.value});U.value=s.applications.map(n=>{var u,S,b,z,i,k,R,J,G,H;return{id:n.id,student:{id:n.student_id,name:((u=n.profiles)==null?void 0:u.real_name)||"未知学生",avatar:((S=n.profiles)==null?void 0:S.avatar_url)||"",school:((b=n.profiles)==null?void 0:b.school)||"",major:((z=n.profiles)==null?void 0:z.major)||"",grade:((i=n.profiles)==null?void 0:i.grade)||"",phone:((k=n.profiles)==null?void 0:k.phone)||"",email:((R=n.profiles)==null?void 0:R.email)||""},job:{id:n.job_id,title:((J=n.jobs)==null?void 0:J.title)||"未知职位"},applyTime:n.created_at||n.applied_at,status:n.status,message:n.cover_letter||"",resume:{education:((G=n.profiles)==null?void 0:G.bio)||"",skills:((H=n.profiles)==null?void 0:H.skills)||[],experiences:[]}}}),N.value=s.total}catch(a){console.error("加载申请记录失败:",a),g.error("加载申请记录失败")}finally{I.value=!1}},Q=a=>{B.value=a,L.value=!0},q=async(a,s)=>{try{let n="",u="确定";switch(s){case"reviewing":n="确定开始审核此申请吗？";break;case"accepted":n="确定通过此申请吗？通过后系统将自动发送面试通知给学生",u="通过申请";break;case"rejected":n="确定拒绝此申请吗？拒绝后学生将收到通知",u="拒绝申请";break}await te.confirm(n,"确认操作",{confirmButtonText:u,cancelButtonText:"取消",type:"warning"}),await F.updateApplicationStatus(a.id,s),a.status=s,g.success("操作成功"),s==="accepted"?(await F.sendInterviewNotification(a.id),g.success("已发送面试通知给学生")):s==="rejected"&&(await F.sendRejectionNotification(a.id),g.info("已发送拒绝通知给学生")),await j()}catch(n){console.error("处理申请失败:",n),g.error("操作失败，请重试")}},W=(a,s)=>{const n=U.value.find(u=>u.id===a);n&&(n.status=s)},X=async()=>{D.value=1,await j(),g.success("筛选条件已应用")},Y=async()=>{f.value="",T.value=[],D.value=1,await j(),g.success("筛选条件已重置")},l=a=>new Date(a).toLocaleDateString("zh-CN"),e=a=>({pending:"warning",reviewing:"info",accepted:"success",rejected:"danger"})[a]||"info",o=a=>({pending:"待处理",reviewing:"审核中",accepted:"已通过",rejected:"已拒绝"})[a]||"未知",_=async a=>{D.value=a,await j()};return ie(async()=>{await j()}),(a,s)=>{const n=w("el-option"),u=w("el-select"),S=w("el-date-picker"),b=w("el-button"),z=w("el-card"),i=w("el-avatar"),k=w("el-table-column"),R=w("el-tag"),J=w("el-table"),G=w("el-pagination"),H=oe("loading");return v(),y("div",it,[d(z,{class:"filter-card"},{default:r(()=>[t("div",ot,[t("div",lt,[d(u,{modelValue:f.value,"onUpdate:modelValue":s[0]||(s[0]=c=>f.value=c),placeholder:"选择岗位",clearable:"",style:{width:"200px"}},{default:r(()=>[(v(!0),y(K,null,O(V.value,c=>(v(),$(n,{key:c.id,label:c.title,value:c.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"]),d(S,{modelValue:T.value,"onUpdate:modelValue":s[1]||(s[1]=c=>T.value=c),type:"daterange","range-separator":"至","start-placeholder":"开始日期","end-placeholder":"结束日期",style:{width:"240px"}},null,8,["modelValue"])]),t("div",rt,[d(b,{onClick:Y},{default:r(()=>[...s[5]||(s[5]=[h("重置",-1)])]),_:1}),d(b,{type:"primary",onClick:X},{default:r(()=>[...s[6]||(s[6]=[h("筛选",-1)])]),_:1})])])]),_:1}),d(z,null,{header:r(()=>[t("div",ct,[t("span",null,m(o(p.statusFilter))+"申请列表",1),t("span",dt,"共 "+m(N.value)+" 条申请",1)])]),default:r(()=>[le((v(),$(J,{data:U.value},{default:r(()=>[d(k,{label:"学生信息","min-width":"200"},{default:r(({row:c})=>[t("div",ut,[d(i,{size:40,src:c.student.avatar},null,8,["src"]),t("div",pt,[t("div",mt,m(c.student.name),1),t("div",vt,m(c.student.school)+" · "+m(c.student.major)+" · "+m(c.student.grade),1)])])]),_:1}),d(k,{prop:"job.title",label:"申请岗位",width:"180"}),d(k,{label:"申请时间",width:"140"},{default:r(({row:c})=>[h(m(l(c.applyTime)),1)]),_:1}),d(k,{label:"状态",width:"100"},{default:r(({row:c})=>[d(R,{type:e(c.status)},{default:r(()=>[h(m(o(c.status)),1)]),_:2},1032,["type"])]),_:1}),d(k,{label:"操作",width:"200",fixed:"right"},{default:r(({row:c})=>[d(b,{size:"small",onClick:Z=>Q(c)},{default:r(()=>[...s[7]||(s[7]=[h(" 查看详情 ",-1)])]),_:1},8,["onClick"]),c.status==="pending"?(v(),$(b,{key:0,size:"small",type:"primary",onClick:Z=>q(c,"reviewing")},{default:r(()=>[...s[8]||(s[8]=[h(" 开始审核 ",-1)])]),_:1},8,["onClick"])):c.status==="reviewing"?(v(),$(b,{key:1,size:"small",type:"success",onClick:Z=>q(c,"accepted")},{default:r(()=>[...s[9]||(s[9]=[h(" 通过 ",-1)])]),_:1},8,["onClick"])):c.status==="reviewing"?(v(),$(b,{key:2,size:"small",type:"danger",onClick:Z=>q(c,"rejected")},{default:r(()=>[...s[10]||(s[10]=[h(" 拒绝 ",-1)])]),_:1},8,["onClick"])):M("",!0)]),_:1})]),_:1},8,["data"])),[[H,I.value]]),t("div",_t,[d(G,{"current-page":D.value,"onUpdate:currentPage":s[2]||(s[2]=c=>D.value=c),"page-size":A.value,"onUpdate:pageSize":s[3]||(s[3]=c=>A.value=c),total:N.value,layout:"prev, pager, next, jumper",onCurrentChange:_},null,8,["current-page","page-size","total"])])]),_:1}),d(nt,{visible:L.value,"onUpdate:visible":s[4]||(s[4]=c=>L.value=c),application:B.value,onStatusChange:W},null,8,["visible","application"])])}}});const wt=ae(gt,[["__scopeId","data-v-01586697"]]);export{wt as C};
